<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>KindeAuth</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/index.css}"/>
</head>
<body>
<div class="wrapper">
    <header>
        <nav class="nav container">
            <h1 class="text-display-3">KindeAuth with Spring Boot</h1>
            <div class="profile-blob">
                <div>
                    <p class="text-heading-2" th:text="${fullName}"></p>
                    <a class="text-subtle" href="/logout">Sign out</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="content">
        <div class="container">
            <div class="card start-hero">
                <p class="text-body-2 start-hero-intro">Woohoo!</p>
                <p class="text-display-2">
                    Your authentication is all sorted.
                    <br/>
                    Build the important stuff.
                </p>
            </div>
            <div class="horizontal-sections">
                <section class="next-steps-section card">
                    <h2 class="text-display-3">Access Token:</h2>
                    <br/>
                    <p class="text-heading-2 token-text">
                        <span th:text="${token.substring(0, 20)} + '...'"></span>
                        <a href="#" class="view-link" onclick="openTokenPopup()">[View]</a>
                    </p>
                    <br/>
                    <a class="btn btn-light" th:href="'https://jwt.io/#debugger-io?token=' + ${token}" target="_blank">
                        Parse token on JWT.io
                    </a>
                </section>

                <section class="next-steps-section card">
                    <h2 class="text-display-3">User Profile:</h2>
                    <br/>
                    <p class="text-heading-2 token-text">
                        <span th:text="${userprofile.substring(0, 20)} + '...'"></span>
                        <a href="#" class="view-link" data-popup="userprofile" onclick="openPopup(this)">[View]</a>
                    </p>
                    <br/>
                </section>
            </div>

            <!-- Popup container -->
            <div id="tokenPopup" class="popup">
                <div class="popup-content">
                    <span class="close" onclick="closeTokenPopup()">&times;</span>
                    <p th:text="${token}"></p>
                </div>
            </div>

            <!-- Script tag to store JSON -->
            <script id="userProfileJson" type="application/json" th:text="${userprofile}"></script>

            <!-- Popup container -->
            <div id="userProfilePopup" class="popup">
                <div class="popup-content">
                    <span class="close" onclick="closePopup()">&times;</span>
                    <pre id="popupText"></pre>
                </div>
            </div>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <strong class="text-heading-2">KindeAuth</strong>
            <p class="footer-tagline text-body-3">
                Browse Kinde
                <a class="link" href="https://kinde.com/docs">docs</a>
            </p>

            <small class="text-subtle">Â© 2024 KindeAuth, Inc. All rights reserved</small>
        </div>
    </footer>
</div>

<script>
    function openTokenPopup() {
        document.getElementById("tokenPopup").style.display = "block";
    }

    function closeTokenPopup() {
        document.getElementById("tokenPopup").style.display = "none";
    }

    function openPopup(element) {
        var popupType = element.getAttribute('data-popup');
        var popup = document.getElementById("userProfilePopup");
        var popupText = document.getElementById("popupText");

        var content;
        if (popupType === 'token') {
            content = document.getElementById("fullToken").innerText;
            content = fullToken ? fullToken.textContent : "Error: Token not found.";
        } else if (popupType === 'userprofile') {
            // Fetch JSON data from the script tag and format it
            var userProfileJson = document.getElementById("userProfileJson").textContent;

            // Decode HTML entities
            var parser = new DOMParser();
            var doc = parser.parseFromString(userProfileJson, 'text/html');
            var decodedJson = doc.documentElement.textContent;
            try {
                var userProfile = JSON.parse(decodedJson);
                content = JSON.stringify(userProfile, null, 2); // Format JSON with indentation
            } catch (e) {
                console.error("Error parsing user profile data:", e);
                content = "Error parsing user profile data.";
            }
        }

        popupText.textContent = content; // Display the content in the popup
        userProfilePopup.style.display = "block";
    }

    function closePopup() {
        var popup = document.getElementById("userProfilePopup");
        popup.style.display = "none";
    }

    // Optional: Close the popup if the user clicks anywhere outside of it
    window.onclick = function(event) {
        var tokenPopup = document.getElementById("tokenPopup");
        var userProfilePopup = document.getElementById("userProfilePopup");
        if (event.target == tokenPopup) {
            tokenPopup.style.display = "none";
        }
        if (event.target == userProfilePopup) {
            userProfilePopup.style.display = "none";
        }
    }
</script>

</body>
</html>